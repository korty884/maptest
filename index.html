<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>地理院地図 3Dビューア v0.3</title>
    <!-- Tailwind CSS CDN (バージョン指定に変更) -->
    <script src="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css"></script>
    <style>
        /* Interフォントのインポート */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 0;
            overflow: hidden; /* スクロールバーを非表示 */
        }
        #cesiumContainer {
            width: 100vw;
            height: 100vh;
            position: absolute;
            top: 0;
            left: 0;
            z-index: 0;
        }
        #controls {
            position: absolute;
            top: 1rem;
            left: 1rem;
            background-color: rgba(255, 255, 255, 0.9);
            padding: 1rem;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            z-index: 1;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        .layer-control label {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            cursor: pointer;
        }
        .layer-control input[type="checkbox"] {
            transform: scale(1.2);
        }
        /* ローディング表示用のスタイル */
        #loadingOverlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.5rem;
            z-index: 1000;
        }
    </style>
    <!-- CesiumJSのCSSとJavaScriptを読み込む (バージョンを1.60にダウングレード) -->
    <link href="https://cesium.com/downloads/cesiumjs/releases/1.60/Build/Cesium/Widgets/widgets.css" rel="stylesheet">
    <script src="https://cesium.com/downloads/cesiumjs/releases/1.60/Build/Cesium/Cesium.js"></script>
</head>
<body>
    <div id="loadingOverlay">地図を読み込み中...</div>
    <div id="cesiumContainer"></div>
    <div id="controls" class="rounded-lg">
        <h2 class="text-lg font-bold mb-2">レイヤー切り替え</h2>
        <div class="layer-control">
            <label>
                <input type="checkbox" id="baseMapToggle" checked>
                標準地図
            </label>
        </div>
        <div class="layer-control">
            <label>
                <input type="checkbox" id="aerialPhotoToggle">
                航空写真
            </label>
        </div>
        <div class="layer-control">
            <label>
                <input type="checkbox" id="contourToggle">
                等高線
            </label>
        </div>
        <div class="layer-control">
            <label>
                <input type="checkbox" id="landUseToggle">
                土地利用図
            </label>
        </div>
        <div class="layer-control">
            <label>
                <input type="checkbox" id="dem5aToggle">
                色別標高図
            </label>
        </div>
    </div>

    <script>
        // CesiumJSのアセットのパスを明示的に設定します。(バージョンを1.60に合わせる)
        Cesium.buildModuleUrl.setBaseUrl('https://cesium.com/downloads/cesiumjs/releases/1.60/Build/Cesium/');

        // Cesiumビューアを初期化
        try {
            const viewer = new Cesium.Viewer('cesiumContainer', {
                baseLayerPicker: false, // ベースレイヤーピッカーを非表示
                // 初期ベースマップを地理院地図の標準地図に直接設定
                imageryProvider: new Cesium.UrlTemplateImageryProvider({
                    url: 'https://cyberjapandata.gsi.go.jp/xyz/std/{z}/{x}/{y}.png',
                    credit: '国土地理院'
                }),
                // 3D地形を有効にする
                terrainProvider: new Cesium.CesiumTerrainProvider({
                    url: 'https://cyberjapandata.gsi.go.jp/xyz/dem/' // 地理院地図のDEMタイル
                }),
                requestRenderMode: true,
                maximumRenderTimeChange: Infinity,

                geocoder: false,
                homeButton: false,
                infoBox: false,
                navigationHelpButton: false,
                sceneModePicker: false,
                animation: false,
                timeline: false,
                fullscreenButton: false,
                vrButton: false,
                selectionIndicator: false,
                shadows: false,
            });
            console.log('Cesium Viewer initialized successfully.');

            // ローディングオーバーレイを非表示にする
            document.getElementById('loadingOverlay').style.display = 'none';

            // 初期カメラ位置を設定 (名古屋付近の緯度経度と、非常に高い高度を設定)
            const initialLat = 35.13328136774088;
            const initialLon = 136.50278806686404;
            const initialHeight = 1000000; // 1000km上空から見下ろす

            viewer.camera.setView({
                destination: Cesium.Cartesian3.fromDegrees(initialLon, initialLat, initialHeight),
                orientation: {
                    heading: Cesium.Math.toRadians(0.0),
                    pitch: Cesium.Math.toRadians(-90.0), // 真上から見下ろす
                    roll: 0.0
                }
            });

            // 地理院地図の各レイヤーを追加 (ベースマップは既に設定済みなので、ここでは追加しない)

            // 航空写真
            const aerialPhotoLayer = viewer.imageryLayers.addImageryProvider(
                new Cesium.UrlTemplateImageryProvider({
                    url: 'https://cyberjapandata.gsi.go.jp/xyz/seamlessphoto/{z}/{x}/{y}.jpg',
                    credit: '国土地理院'
                })
            );
            aerialPhotoLayer.show = false;

            // 等高線
            const contourLayer = viewer.imageryLayers.addImageryProvider(
                new Cesium.UrlTemplateImageryProvider({
                    url: 'https://cyberjapandata.gsi.go.jp/xyz/cont/{z}/{x}/{y}.png',
                    credit: '国土地理院'
                })
            );
            contourLayer.show = false;

            // 土地利用図
            const landUseLayer = viewer.imageryLayers.addImageryProvider(
                new Cesium.UrlTemplateImageryProvider({
                    url: 'https://cyberjapandata.gsi.go.jp/xyz/lcomu/{z}/{x}/{y}.png',
                    credit: '国土地理院'
                })
            );
            landUseLayer.show = false;

            // 色別標高図 (DEM5A)
            const dem5aLayer = viewer.imageryLayers.addImageryProvider(
                new Cesium.UrlTemplateImageryProvider({
                    url: 'https://cyberjapandata.gsi.go.jp/xyz/dem5a/{z}/{x}/{y}.png',
                    credit: '国土地理院'
                })
            );
            dem5aLayer.show = false;

            // レイヤー切り替えのイベントリスナーを設定
            // 標準地図は初期ベースマップなので、このトグルは航空写真との切り替えに使う
            document.getElementById('baseMapToggle').addEventListener('change', function() {
                // 標準地図はデフォルトで表示されているため、ここでは航空写真との排他制御のみ
                // baseMapLayer.show = this.checked; // この行は不要
                if (this.checked) {
                    viewer.imageryLayers.get(0).show = true; // デフォルトの標準地図を表示
                    aerialPhotoLayer.show = false;
                    document.getElementById('aerialPhotoToggle').checked = false;
                } else {
                    viewer.imageryLayers.get(0).show = false; // デフォルトの標準地図を非表示
                }
            });

            document.getElementById('aerialPhotoToggle').addEventListener('change', function() {
                aerialPhotoLayer.show = this.checked;
                if (this.checked) {
                    viewer.imageryLayers.get(0).show = false; // 標準地図を非表示
                    document.getElementById('baseMapToggle').checked = false;
                } else {
                    viewer.imageryLayers.get(0).show = true; // 標準地図を再表示 (航空写真がオフになったら)
                    document.getElementById('baseMapToggle').checked = true;
                }
            });

            document.getElementById('contourToggle').addEventListener('change', function() {
                contourLayer.show = this.checked;
            });

            document.getElementById('landUseToggle').addEventListener('change', function() {
                landUseLayer.show = this.checked;
            });

            document.getElementById('dem5aToggle').addEventListener('change', function() {
                dem5aLayer.show = this.checked;
            });

        } catch (error) {
            console.error('Failed to initialize Cesium Viewer:', error);
            const errorDiv = document.createElement('div');
            errorDiv.style.position = 'absolute';
            errorDiv.style.top = '50%';
            errorDiv.style.left = '50%';
            errorDiv.style.transform = 'translate(-50%, -50%)';
            errorDiv.style.backgroundColor = 'rgba(255, 0, 0, 0.8)';
            errorDiv.style.color = 'white';
            errorDiv.style.padding = '20px';
            errorDiv.style.borderRadius = '10px';
            errorDiv.style.zIndex = '100';
            errorDiv.innerText = '地図の読み込み中にエラーが発生しました。ブラウザのコンソールをご確認ください。';
            document.body.appendChild(errorDiv);
            document.getElementById('loadingOverlay').style.display = 'none';
        }
    </script>
</body>
</html>
