<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>地理院地図 3Dビューア</title>
    <!-- Tailwind CSS CDN (バージョン指定に変更) -->
    <script src="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css"></script>
    <style>
        /* Interフォントのインポート */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 0;
            overflow: hidden; /* スクロールバーを非表示 */
        }
        #cesiumContainer {
            width: 100vw;
            height: 100vh;
            position: absolute;
            top: 0;
            left: 0;
            z-index: 0;
        }
        #controls {
            position: absolute;
            top: 1rem;
            left: 1rem;
            background-color: rgba(255, 255, 255, 0.9);
            padding: 1rem;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            z-index: 1;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        .layer-control label {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            cursor: pointer;
        }
        .layer-control input[type="checkbox"] {
            transform: scale(1.2);
        }
        /* ローディング表示用のスタイル */
        #loadingOverlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.5rem;
            z-index: 1000;
        }
    </style>
    <!-- CesiumJSのCSSとJavaScriptを読み込む -->
    <link href="https://cesium.com/downloads/cesiumjs/releases/1.118/Build/Cesium/Widgets/widgets.css" rel="stylesheet">
    <script src="https://cesium.com/downloads/cesiumjs/releases/1.118/Build/Cesium/Cesium.js"></script>
</head>
<body>
    <div id="loadingOverlay">地図を読み込み中...</div>
    <div id="cesiumContainer"></div>
    <div id="controls" class="rounded-lg">
        <h2 class="text-lg font-bold mb-2">レイヤー切り替え</h2>
        <div class="layer-control">
            <label>
                <input type="checkbox" id="baseMapToggle" checked>
                標準地図
            </label>
        </div>
        <div class="layer-control">
            <label>
                <input type="checkbox" id="aerialPhotoToggle">
                航空写真
            </label>
        </div>
        <!-- 修正: aerialPhotoToggleの重複を削除 -->
        <div class="layer-control">
            <label>
                <input type="checkbox" id="contourToggle">
                等高線
            </label>
        </div>
        <div class="layer-control">
            <label>
                <input type="checkbox" id="landUseToggle">
                土地利用図
            </label>
        </div>
        <div class="layer-control">
            <label>
                <input type="checkbox" id="dem5aToggle">
                色別標高図
            </label>
        </div>
    </div>

    <script>
        // CesiumJSのアセットのパスを明示的に設定します。
        // これにより、CDNからロードされたCesiumJSが、必要な画像やWeb Workerなどのアセットを正しく見つけられるようになります。
        Cesium.buildModuleUrl.setBaseUrl('https://cesium.com/downloads/cesiumjs/releases/1.118/Build/Cesium/');

        // CesiumJSのアクセストークンを設定します。
        // これはCesium Ionのデフォルトのベースマップなどを利用する場合に必要ですが、
        // 地理院地図のタイルのみを利用する場合は必須ではありません。
        // Cesium.Ion.defaultAccessToken = 'YOUR_CESIUM_ION_ACCESS_TOKEN'; // 必要であれば設定

        // Cesiumビューアを初期化
        try {
            const viewer = new Cesium.Viewer('cesiumContainer', {
                // ベースレイヤーを非表示にし、地理院地図を自分で追加します
                baseLayerPicker: false,
                // デフォルトのImageryProviderを無効にする (401エラー対策)
                imageryProvider: false,
                // 3D地形を有効にする
                terrainProvider: new Cesium.CesiumTerrainProvider({
                    url: 'https://cyberjapandata.gsi.go.jp/xyz/dem/' // 地理院地図のDEMタイル
                }),
                // レンダリングモードを設定 (地形表示の安定化のため)
                requestRenderMode: true,
                maximumRenderTimeChange: Infinity, // 常にレンダリングを試みる

                // その他のUI要素を非表示（オプション）
                geocoder: false,
                homeButton: false,
                infoBox: false,
                navigationHelpButton: false,
                sceneModePicker: false,
                animation: false,
                timeline: false,
                fullscreenButton: false,
                vrButton: false,
                selectionIndicator: false,
                shadows: false,
            });
            console.log('Cesium Viewer initialized successfully.'); // 成功ログ

            // ローディングオーバーレイを非表示にする
            document.getElementById('loadingOverlay').style.display = 'none';

            // 初期カメラ位置を設定 (地理院地図のURLから取得した緯度経度とズームレベルを使用)
            const initialLat = 35.13328136774088;
            const initialLon = 136.50278806686404;
            const initialZoomLevel = 15; // ズームレベルはカメラの高さに変換する必要があります

            // ズームレベルを高さに変換するおおよその関数 (正確な変換ではありませんが、目安として)
            function zoomLevelToHeight(zoom) {
                // 経験則に基づく変換。以前より高い位置に設定
                return 100000000 / Math.pow(2, zoom); // 以前の60000000から調整
            }

            viewer.camera.setView({
                destination: Cesium.Cartesian3.fromDegrees(initialLon, initialLat, zoomLevelToHeight(initialZoomLevel)),
                orientation: {
                    heading: Cesium.Math.toRadians(0.0), // 北を向く
                    pitch: Cesium.Math.toRadians(-35.0), // 少し下向き (以前の -20.0 から調整)
                    roll: 0.0
                }
            });

            // 地理院地図の各レイヤーを追加
            // 標準地図 (初期表示)
            const baseMapLayer = viewer.imageryLayers.addImageryProvider(
                new Cesium.UrlTemplateImageryProvider({
                    url: 'https://cyberjapandata.gsi.go.jp/xyz/std/{z}/{x}/{y}.png',
                    credit: '国土地理院'
                })
            );
            baseMapLayer.show = true; // 初期表示

            // 航空写真
            const aerialPhotoLayer = viewer.imageryLayers.addImageryProvider(
                new Cesium.UrlTemplateImageryProvider({
                    url: 'https://cyberjapandata.gsi.go.jp/xyz/seamlessphoto/{z}/{x}/{y}.jpg',
                    credit: '国土地理院'
                })
            );
            aerialPhotoLayer.show = false; // 初期非表示

            // 等高線
            const contourLayer = viewer.imageryLayers.addImageryProvider(
                new Cesium.UrlTemplateImageryProvider({
                    url: 'https://cyberjapandata.gsi.go.jp/xyz/cont/{z}/{x}/{y}.png',
                    credit: '国土地理院'
                })
            );
            contourLayer.show = false; // 初期非表示

            // 土地利用図
            const landUseLayer = viewer.imageryLayers.addImageryProvider(
                new Cesium.UrlTemplateImageryProvider({
                    url: 'https://cyberjapandata.gsi.go.jp/xyz/lcomu/{z}/{x}/{y}.png',
                    credit: '国土地理院'
                })
            );
            landUseLayer.show = false; // 初期非表示

            // 色別標高図 (DEM5A) - これは地形の高さを示す色付きの地図です
            const dem5aLayer = viewer.imageryLayers.addImageryProvider(
                new Cesium.UrlTemplateImageryProvider({
                    url: 'https://cyberjapandata.gsi.go.jp/xyz/dem5a/{z}/{x}/{y}.png',
                    credit: '国土地理院'
                })
            );
            dem5aLayer.show = false; // 初期非表示

            // レイヤー切り替えのイベントリスナーを設定
            document.getElementById('baseMapToggle').addEventListener('change', function() {
                baseMapLayer.show = this.checked;
                // 標準地図がオンになったら航空写真をオフにする
                if (this.checked) {
                    aerialPhotoLayer.show = false;
                    document.getElementById('aerialPhotoToggle').checked = false;
                }
            });

            document.getElementById('aerialPhotoToggle').addEventListener('change', function() {
                aerialPhotoLayer.show = this.checked;
                // 航空写真がオンになったら標準地図をオフにする
                if (this.checked) {
                    baseMapLayer.show = false;
                    document.getElementById('baseMapToggle').checked = false;
                }
            });

            document.getElementById('contourToggle').addEventListener('change', function() {
                contourLayer.show = this.checked;
            });

            document.getElementById('landUseToggle').addEventListener('change', function() {
                landUseLayer.show = this.checked;
            });

            document.getElementById('dem5aToggle').addEventListener('change', function() {
                dem5aLayer.show = this.checked;
            });

            // 建物データについて:
            // 地理院地図の3D表示は独自の建物データを使用している可能性があります。
            // CesiumJSで一般的な3D建物データを表示するには、3D Tiles形式のデータが必要です。
            // 現在、地理院地図が公開している一般的な3D Tiles形式の建物データは確認できませんでした。
            // もし建物データを追加したい場合は、OpenStreetMapのデータから3D Tilesを生成するか、
            // 他の公開されている3D建物データセットを探す必要があります。
            // この例では、地理院地図のImageryLayerとして提供されているものに限定しています。
        } catch (error) {
            console.error('Failed to initialize Cesium Viewer:', error); // エラーログ
            // ユーザーにエラーメッセージを表示
            const errorDiv = document.createElement('div');
            errorDiv.style.position = 'absolute';
            errorDiv.style.top = '50%';
            errorDiv.style.left = '50%';
            errorDiv.style.transform = 'translate(-50%, -50%)';
            errorDiv.style.backgroundColor = 'rgba(255, 0, 0, 0.8)';
            errorDiv.style.color = 'white';
            errorDiv.style.padding = '20px';
            errorDiv.style.borderRadius = '10px';
            errorDiv.style.zIndex = '100';
            errorDiv.innerText = '地図の読み込み中にエラーが発生しました。ブラウザのコンソールをご確認ください。';
            document.body.appendChild(errorDiv);
            document.getElementById('loadingOverlay').style.display = 'none'; // エラー時はローディングを非表示
        }
    </script>
</body>
</html>
